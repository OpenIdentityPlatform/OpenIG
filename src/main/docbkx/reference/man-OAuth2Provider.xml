<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at legal/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2015 ForgeRock AS.
  !
-->
<refentry xml:id="OAuth2Provider"
          xmlns="http://docbook.org/ns/docbook"
          version="5.0" xml:lang="en"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://docbook.org/ns/docbook
                              http://docbook.org/xml/5.0/xsd/docbook.xsd"
          xmlns:xlink="http://www.w3.org/1999/xlink">

 <refmeta>
  <refentrytitle>OAuth2Provider</refentrytitle><manvolnum>5</manvolnum>
 </refmeta>

 <refnamediv>
  <refname>OAuth2Provider</refname>
  <refpurpose>Describe an Authorization Server or OpenID Provider</refpurpose>
 </refnamediv>

 <refsect1 xml:id="OAuth2Provider-description">
  <title>Description</title>

  <indexterm>
   <primary>Miscellaneous Heap Objects</primary>
   <secondary>OAuth2Provider</secondary>
  </indexterm>

  <para>
   An OAuth2Provider describes an OAuth 2.0 Authorization Server
   or an OpenID Provider with which ${projectName} is registered
   as a OAuth 2.0 client or OpenID Connect relying party.
  </para>

  <para>
   An OAuth2Provider is generally referenced from an
   <link
    xlink:show="new"
    xlink:href="reference#OAuth2ClientFilter"
    xlink:role="http://docbook.org/xlink/role/olink"
   >OAuth2ClientFilter</link>.
  </para>
 </refsect1>

 <refsect1>
  <title>Usage</title>

  <programlisting language="javascript">
{
  "name": string,
  "type": "OAuth2Provider",
  "config": {
    "clientId": expression,
    "clientSecret": expression,
    "wellKnownConfiguration": URL string,
    "authorizeEndpoint": URI expression,
    "tokenEndpoint": URI expression,
    "tokenEndpointUseBasicAuth": boolean,
    "userInfoEndpoint": URI expression,
    "scopes": [ expression, ... ]
    "providerHandler": Handler reference
  }
}
  </programlisting>
 </refsect1>

 <refsect1>
  <title>Properties</title>

  <para>
   If the provider has a well-known configuration URL
   as defined for OpenID Connect 1.0 Discovery
   that returns JSON with at least authorization and token endpoint URLs,
   then you can specify that URL in the provider configuration.
   Otherwise, you must specify
   at least the provider authorization and token endpoint URLs,
   and optionally the user info endpoint URL.
  </para>

  <variablelist>
   <para>
    The provider configuration object properties are as follows.
   </para>

   <varlistentry>
    <term><code>"name"</code>: <emphasis>string, required</emphasis></term>
    <listitem>
     <para>
      A name for the provider configuration.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"clientId"</code>: <emphasis><link
     xlink:href="reference#Expressions"
     xlink:role="http://docbook.org/xlink/role/olink">expression</link>,
     required</emphasis></term>
    <listitem>
     <para>
      The <literal>client_id</literal> obtained
      when registering with the provider.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"clientSecret"</code>: <emphasis><link
     xlink:href="reference#Expressions"
     xlink:role="http://docbook.org/xlink/role/olink">expression</link>,
     required</emphasis></term>
    <listitem>
     <para>
      The <literal>client_secret</literal> obtained
      when registering with the provider.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"wellKnownConfiguration"</code>: <emphasis>URL string,
     required unless "authorizeEndpoint" and "tokenEndpoint" are specified</emphasis></term>
    <listitem>
     <para>
      The URL to the well-known configuration resource
      as described in OpenID Connect 1.0 Discovery.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"authorizeEndpoint"</code>: <emphasis><link
     xlink:href="reference#Expressions"
     xlink:role="http://docbook.org/xlink/role/olink">expression</link>,
     required unless obtained through "wellKnownConfiguration"</emphasis></term>
    <listitem>
     <para>
      The URL to the provider's OAuth 2.0 authorization endpoint.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"tokenEndpoint"</code>: <emphasis><link
     xlink:href="reference#Expressions"
     xlink:role="http://docbook.org/xlink/role/olink">expression</link>,
     required unless obtained through "wellKnownConfiguration"</emphasis></term>
    <listitem>
     <para>
      The URL to the provider's OAuth 2.0 token endpoint.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"tokenEndpointUseBasicAuth"</code>: <emphasis>boolean, optional</emphasis></term>
    <listitem>
     <para>
      Whether to perform client authentication to the provider
      using HTTP Basic authentication when sending a request
      to the provider's OAuth 2.0 token endpoint.
     </para>

     <para>
      When set to <literal>true</literal>,
      the client credentials are sent using HTTP Basic authentication
      as in the following example request:
     </para>

     <programlisting language="http">
POST /oauth2/token HTTP/1.1
Host: as.example.com
Authorization: Basic ....
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;code=...
     </programlisting>

     <para>
      When set to <literal>false</literal>,
      the client credentials are sent in HTTP POST form data
      as in the following example request:
     </para>

     <programlisting language="http">
POST /oauth2/token HTTP/1.1
Host: as.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;client_id=.....&amp;client_secret=.....&amp;code=...
     </programlisting>

     <para>
      Some providers accept both authentication methods.
      For providers that strictly enforce how the client must authenticate,
      such as recent versions of OpenAM,
      you must align the configuration with that of the provider.
     </para>

     <para>
      If the provider does not support the configured authentication method,
      then according to RFC 6749
      <link
       xlink:href="https://tools.ietf.org/html/rfc6749#section-5.2"
       xlink:show="new"
      ><citetitle>The OAuth 2.0 Authorization Framework</citetitle>,
      section 5.2</link>
      the provider sends an HTTP 400 Bad Request response
      with an <literal>invalid_client</literal> error message
      as in the following example response:
     </para>

     <programlisting language="http">
HTTP/1.1 400 Bad Request
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
  "error":"invalid_client"
}
     </programlisting>

     <para>
      Default: <literal>true</literal>
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"userInfoEndpoint"</code>: <emphasis><link
     xlink:href="reference#Expressions"
     xlink:role="http://docbook.org/xlink/role/olink">expression</link>,
     optional</emphasis></term>
    <listitem>
     <para>
      The URL to the provider's OpenID Connect UserInfo endpoint.
     </para>

     <para>
      Default: no UserInfo is obtained from the provider.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"scopes"</code>: <emphasis>array of <link
     xlink:href="reference#Expressions"
     xlink:role="http://docbook.org/xlink/role/olink">expression</link>s,
     optional</emphasis></term>
    <listitem>
     <para>
      Overrides the list of scopes specified globally
      in the context where the provider is used.
     </para>

     <para>
      Default: use the list of scopes specified by the filter using this provider.
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"providerHandler"</code>: <emphasis><link
     xlink:show="new"
     xlink:href="reference#handlers-conf"
     xlink:role="http://docbook.org/xlink/role/olink"
    >Handler</link> reference, optional</emphasis></term>
    <listitem>
     <para>
      Invoke this HTTP client handler to communicate with the provider.
     </para>

     <para>
      Provide either the name of a Handler object defined in the heap,
      or an inline Handler configuration object.
     </para>

     <para>
      Usually set this to the name of a
      <link
       xlink:show="new"
       xlink:href="reference#ClientHandler"
       xlink:role="http://docbook.org/xlink/role/olink"
      >ClientHandler</link> configured in the heap,
      or a chain that ends in a ClientHandler.
     </para>

     <para>
      Default: use the default client handler.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </refsect1>

 <refsect1>
  <title>Example</title>

  <para>
   The following example shows two provider configurations,
   one for OpenAM and the other for Google.
   OpenAM exposes a well-known endpoint for the provider configuration,
   but this example demonstrates use of the other fields.
   The client credentials are not shown.
  </para>

  <programlisting language="javascript">
[
    {
        "name": "openam",
        "type": "OAuth2Provider",
        "config": {
            "authorizeEndpoint":
              "https://openam.example.com:8443/openam/oauth2/authorize",
            "tokenEndpoint":
              "https://openam.example.com:8443/openam/oauth2/access_token",
            "userInfoEndpoint":
              "https://openam.example.com:8443/openam/oauth2/userinfo",
            "clientId": "********",
            "clientSecret": "********"
        }
    },
    {
        "name": "google",
        "type": "OAuth2Provider",
        "config": {
            "wellKnownConfiguration":
              "https://accounts.google.com/.well-known/openid-configuration",
            "clientId": "**************.apps.googleusercontent.com",
            "clientSecret": "**************"
        }
    }
]
  </programlisting>
 </refsect1>

 <refsect1>
  <title>Javadoc</title>
  <para>
   <link
    xlink:show="new"
    xlink:href="${javadocBase}/index.html?org/forgerock/openig/filter/oauth2/client/OAuth2Provider.html"
   >org.forgerock.openig.filter.oauth2.client.OAuth2Provider</link></para>
 </refsect1>
</refentry>
