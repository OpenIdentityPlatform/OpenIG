<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at legal/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2014-2015 ForgeRock AS.
  !
-->
<refentry xml:id="TimerDecorator"
          xmlns="http://docbook.org/ns/docbook" version="5.0" xml:lang="en"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://docbook.org/ns/docbook
                              http://docbook.org/xml/5.0/xsd/docbook.xsd"
          xmlns:xlink="http://www.w3.org/1999/xlink"
          xmlns:xinclude="http://www.w3.org/2001/XInclude">
 <refmeta>
  <refentrytitle>TimerDecorator</refentrytitle><manvolnum>5</manvolnum>
 </refmeta>

 <refnamediv>
  <refname>TimerDecorator</refname>
  <refpurpose>record times to process Filters and Handlers</refpurpose>
 </refnamediv>

 <refsect1>
  <title>Description</title>

  <indexterm>
   <primary>Decorators</primary>
   <secondary>TimerDecorator</secondary>
  </indexterm>

  <para>
   Records time in milliseconds to process applicable Filters and Handlers.
   ${projectName} writes the records to the LogSink
   configured for the decorated heap object.
   If no LogSink is defined for the decorated heap object,
   then ${projectName} writes to the LogSink configured for the heap.
   Records include the time elapsed while processing the exchange,
   and for Filters the elapsed time spent processing the exchanged
   within the Filter itself.
  </para>

  <para>
   ${projectName} records times at log level <literal>STAT</literal>.
  </para>

  <para>
   The TimerDecorator is not applicable to the
   <link
    xlink:href="reference#GatewayHttpApplication"
    xlink:show="new"
    xlink:role="http://docbook.org/xlink/role/olink"
   ><citetitle>GatewayHttpApplication</citetitle></link>,
   as the GatewayHttpApplication is not declared in the heap.
  </para>
 </refsect1>

 <refsect1>
  <title>Decorator Usage</title>

  <programlisting language="javascript">
{
    "name": string,
    "type": "TimerDecorator"
}
  </programlisting>

  <para>
   A TimerDecorator does not have configurable properties.
  </para>

  <para>
   ${projectName} configures a default TimerDecorator named "timer".
   You can use "timer" as the decorator name
   without explicitly declaring a decorator named "timer".
  </para>
</refsect1>

 <refsect1>
  <title>Decorated Object Usage</title>

  <programlisting language="javascript">
{
    "name": string,
    "type": string,
    "config": object,
    decorator name: boolean
}
  </programlisting>

  <variablelist>
   <varlistentry>
    <term><code>"name"</code>: string, required except for inline objects</term>
    <listitem>
     <para>
      The unique name of the object, just like an object that is not decorated
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"type"</code>: string, required</term>
    <listitem>
     <para>
      The class name of the decorated object, which must be either a
      <link
       xlink:show="new"
       xlink:href="reference#filters-conf"
       xlink:role="http://docbook.org/xlink/role/olink"
      >Filter</link> or a
      <link
       xlink:show="new"
       xlink:href="reference#handlers-conf"
       xlink:role="http://docbook.org/xlink/role/olink"
      >Handler</link>
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code>"config"</code>: object, required unless empty</term>
    <listitem>
     <para>
      The configuration of the object, just like an object that is not decorated
     </para>
    </listitem>
   </varlistentry>

   <varlistentry>
    <term><code><replaceable>decorator name</replaceable></code>: boolean, required</term>
    <listitem>
     <para>
      ${projectName} looks for the presence
      of the <replaceable>decorator name</replaceable> field
      for the TimerDecorator.
     </para>

     <para>
      To activate the timer,
      set the value of the <replaceable>decorator name</replaceable> field
      to <literal>true</literal>.
     </para>

     <para>
      To deactivate the TimerDecorator temporarily,
      set the value to <literal>false</literal>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </refsect1>

 <refsect1>
  <title>Examples</title>

  <para>
   To record times spent within the client handler,
   and elapsed time for operations traversing the client handler,
   use a configuration such as the following.
  </para>

  <programlisting language="javascript">
{
    "handler": {
        "type": "ClientHandler"
    },
    "timer": true
}
  </programlisting>

  <para>
   This configuration could result in the following log messages.
  </para>

  <programlisting language="none">
TUE DEC 02 17:20:08 CET 2014 (STAT) @Timer[top-level-handler]
Started
------------------------------
TUE DEC 02 17:20:08 CET 2014 (STAT) @Timer[top-level-handler]
Elapsed time: 40 ms
  </programlisting>

  <para>
   When you decorate a Filter with a TimerDecorator,
   ${projectName} can record two timer messages in the LogSink:
   the elapsed time for operations traversing the Filter,
   and the elapsed time spent within the Filter.
  </para>

  <para>
   To record times spent within all Filters and the "handler",
   decorate the Route as in the following example.
  </para>

  <informalexample><?dbfo pgwide="1"?>
   <programlisting language="javascript">
<xinclude:include href="../gateway-guide/resources/config/routes/06-rs.json" parse="text">
 <xinclude:fallback>
  Failed to include JSON
 </xinclude:fallback>
</xinclude:include>
   </programlisting>
  </informalexample>

  <para>
   This configuration could result in the following log messages.
  </para>

  <informalexample><?dbfo pgwide="1"?>
   <programlisting language="none">
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{OAuth2ResourceServerFilter}/handler/config/filters/0]
Started
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{AssignmentFilter}/handler/config/filters/1]
Started
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{StaticRequestFilter}/handler/config/filters/2]
Started
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{StaticRequestFilter}/handler/config/filters/2]
Elapsed time: 119 ms
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{StaticRequestFilter}/handler/config/filters/2]
Elapsed time (within the object): 1 ms
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{AssignmentFilter}/handler/config/filters/1]
Elapsed time: 128 ms
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{AssignmentFilter}/handler/config/filters/1]
Elapsed time (within the object): 7 ms
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{OAuth2ResourceServerFilter}/handler/config/filters/0]
Elapsed time: 211 ms
------------------------------
THU DEC 11 16:06:23 CET 2014 (STAT) @Timer[{OAuth2ResourceServerFilter}/handler/config/filters/0]
Elapsed time (within the object): 81 ms
   </programlisting>
  </informalexample>

  <para>
   You can then deactivate the timer
   by setting the values to <literal>false</literal>.
  </para>

  <programlisting language="javascript">
{
    "timer": false
}
  </programlisting>
 </refsect1>

 <refsect1>
  <title>Javadoc</title>

  <para>
   <link
    xlink:show="new"
    xlink:href="${javadocBase}/index.html?org/forgerock/openig/decoration/timer/TimerDecorator.html"
   >org.forgerock.openig.decoration.timer.TimerDecorator</link>
  </para>
 </refsect1>
</refentry>
